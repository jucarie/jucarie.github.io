<!DOCTYPE html>
<html>
<head>
    <title>2D Maze Game with Dynamic Enemies</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            background-color: black;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        #gameContainer {
            display: flex;
            flex-direction: row;
            justify-content: space-around;

        }
        .canvasContainer {
            position: relative;
        }
        canvas {
            border: 1px solid white;
        }
        .map {
            position: absolute;
            top: 0;
            left: 0;
        }
        #winModal {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border: 2px solid black;
            z-index: 1000;
        }
        #modalOverlay {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .anti_zoom {
            touch-action: manipulation;
        }
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-left: 20px;
        }
        .controls div {
            margin: 5px;
        }
        .controls button {
            width: 60px;
            height: 60px;
            font-size: 18px;
        }
        @media screen and (max-width: 812px) and (orientation: portrait) {
            body {
                transform: rotate(-90deg);
                transform-origin: left top;
                width: 100vh;
                height: 100vw;
                overflow-x: hidden;
                position: absolute;
                top: 100%;
                left: 0;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div class="canvasContainer">
            <canvas id="staticCanvas"></canvas>
            <canvas id="dynamicCanvas" class="map"></canvas>
        </div>
        <div class="controls">
            <div>
                <button id="btnUp" class="anti_zoom">^</button>
            </div>
            <div>
                <button id="btnLeft" class="anti_zoom"><</button>
                <button id="btnDown" class="anti_zoom">v</button>
                <button id="btnRight" class="anti_zoom">></button>
            </div>
        </div>
    </div>

    <div id="modalOverlay"></div>
    <div id="winModal">
        <h1>You Won!</h1>
        <button id="closeModal">Close</button>
    </div>

    <script>
        document.getElementById('btnUp').addEventListener('click', () => moveCharacter(0, -1, image.character.up));
        document.getElementById('btnDown').addEventListener('click', () => moveCharacter(0, 1, image.character.down));
        document.getElementById('btnLeft').addEventListener('click', () => moveCharacter(-1, 0, image.character.left));
        document.getElementById('btnRight').addEventListener('click', () => moveCharacter(1, 0, image.character.right));
    
        const TILE_SIZE = 42;
        const maze = [
            [20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20],
            [20, 1, 1, 1, 20, 1, 1, 1, 1, 1, 20],
            [20, 1, 20, 1, 20, 1, 1, 1, 31, 1, 20],
            [20, 1, 20, 1, 1, 1, 33, 1, 1, 1, 20],
            [20, 4, 20, 20, 1, 20, 1, 20, 1, 1, 20],
            [20, 1, 1, 1, 1, 1, 1, 1, 1, 1, 20],
            [20, 1, 1, 1, 30, 1, 1, 1, 1, 1, 20],
            [20, 1, 32, 1, 1, 1, 1, 1, 9, 1, 20],
            [20, 1, 1, 1, 1, 1, 1, 1, 1, 1, 20],
            [20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20],
        ];

        const MAZE_ROWS = maze.length;
        const MAZE_COLS = maze[0].length;
    
        const staticCanvas = document.getElementById('staticCanvas');
        const mazeCtx = staticCanvas.getContext('2d');
        const dynamicCanvas = document.getElementById('dynamicCanvas');
        const dynamicCtx = dynamicCanvas.getContext('2d');
    
        staticCanvas.width = MAZE_COLS * TILE_SIZE;
        staticCanvas.height = MAZE_ROWS * TILE_SIZE;
        dynamicCanvas.width = MAZE_COLS * TILE_SIZE;
        dynamicCanvas.height = MAZE_ROWS * TILE_SIZE;
    
        const image = {
            floor: new Image(),
            wall: {
                normal: new Image(),
                corner: new Image(),
                lateral: new Image(),
                down: new Image()
            },
            turret: new Image(),
            character: {
                up: new Image(),
                right: new Image(),
                down: new Image(),
                left: new Image()
            },
            end: new Image()
        };
    
        image.floor.src = 'https://jucarie.github.io/img/floor.png';
    
        image.wall.normal.src = 'https://jucarie.github.io/img/wall.png';
        image.wall.corner.src = 'https://jucarie.github.io/img/wall_corner.png';
        image.wall.lateral.src = 'https://jucarie.github.io/img/wall_lateral.png';
        image.wall.down.src = 'https://jucarie.github.io/img/wall_down.png';
    
        image.character.up.src = 'https://jucarie.github.io/img/character_up.png';
        image.character.right.src = 'https://jucarie.github.io/img/character_right.png';
        image.character.down.src = 'https://jucarie.github.io/img/character_down.png';
        image.character.left.src = 'https://jucarie.github.io/img/character_left.png';
    
        image.end.src = 'https://jucarie.github.io/img/end.png';
        image.turret.src = 'https://jucarie.github.io/img/turret.png';
    
        let character;
        let characterImage = image.character.down;
        let dynamicElements = [];
    
        function init() {
            generateMaze();
        }
    
        function generateMaze() {
            let imagesLoaded = 0;
            const requiredImages = [
                image.floor, image.wall.normal, image.end,
                image.character.up, image.character.right, image.character.down, image.character.left
            ];
            requiredImages.forEach((img) => {
                img.onload = () => {
                    imagesLoaded++;
                    if (imagesLoaded === requiredImages.length) {
                        drawStaticMaze();
                        initDynElementsPosition();
                        drawDynamicLayer();
                    }
                };
                img.onerror = () => {
                    console.error("error loading: " + img.src)
                }
            });
        }
    
        function drawStaticMaze() {
            const mazeImage = document.createElement('canvas');
            mazeImage.width = TILE_SIZE * MAZE_COLS;
            mazeImage.height = TILE_SIZE * MAZE_ROWS;
            const mazeImageCtx = mazeImage.getContext('2d');

            const cellImages = {
                1: image.floor,
                20: image.wall.normal,
                21: image.wall.corner,
                22: image.wall.lateral,
                23: image.wall.down,
                4: image.floor,
                9: image.end
            };

            maze.forEach((row, rowIndex) => {
                row.forEach((cell, colIndex) => {
                    if (cellImages[cell]) {
                        mazeImageCtx.drawImage(cellImages[cell], colIndex * TILE_SIZE, rowIndex * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                });
            });

            mazeCtx.drawImage(mazeImage, 0, 0);
        }
    
        function initDynElementsPosition() {
            maze.forEach((row, rowIndex) => {
                row.forEach((cell, colIndex) => {
                    if (cell === 4) {
                        character = { x: colIndex, y: rowIndex };
                    } else if (cell >= 30 && cell <= 33) {
                        const directionMap = {30: 0, 31: 2, 32: 3, 33: 1};
                        dynamicElements.push(createSimpleTurret(colIndex, rowIndex, directionMap[cell]));
                    }
                });
            });
        }
    
        function createSimpleTurret(x, y, direction) {
            return {
                type: 'turret',
                x: x,
                y: y,
                direction: direction,
                
                draw: drawTurret,
                update: updateTurret,
                drawLaserBeam: drawLaserBeam,
                checkCollision: checkTurretCollision
            };
        }
    
        function drawTurret() {
            if (isImageLoaded(image.turret)) {
                dynamicCtx.drawImage(image.turret, this.x * TILE_SIZE, this.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                this.drawLaserBeam();
            } else {
                image.turret.onload = () => {
                    console.log("ReDrawing");
                    drawDynamicLayer();
                };
                image.turret.onerror = () => {
                    console.error("Turret image not found");
                };
            }          
        }
    
        function updateTurret() {
            this.direction = (this.direction + 1) % 4;
        }
    
        function drawLaserBeam() {
            const directions = [[0, -1], [1, 0], [0, 1], [-1, 0]];
            let [dx, dy] = directions[this.direction];
            let x = this.x;
            let y = this.y;
            dynamicCtx.beginPath();
            dynamicCtx.strokeStyle = 'red';
            dynamicCtx.lineWidth = 2;
    
            let startX = (x + 0.5 + dx * 0.5) * TILE_SIZE;
            let startY = (y + 0.5 + dy * 0.5) * TILE_SIZE;
            dynamicCtx.moveTo(startX, startY);
    
            do {
                x += dx;
                y += dy;
            } while (x >= 0 && x < MAZE_COLS && y >= 0 && y < MAZE_ROWS 
            && maze[y][x] !== 20  // Normal wall
            && maze[y][x] !== 21  // Corner wall
            && maze[y][x] !== 22  // Lateral wall
            && maze[y][x] !== 23  // Down wall
            );
    
            let endX = (x + 0.5 - dx * 0.5) * TILE_SIZE;
            let endY = (y + 0.5 - dy * 0.5) * TILE_SIZE;
            dynamicCtx.lineTo(endX, endY);
    
            dynamicCtx.stroke();
        }
    
        function checkTurretCollision(x, y) {
            const directions = [[0, -1], [1, 0], [0, 1], [-1, 0]];
            let [dx, dy] = directions[this.direction];
            let beamX = this.x;
            let beamY = this.y;

            do {
                beamX += dx;
                beamY += dy;
                if (beamX === x && beamY === y) {
                    return true;
                }
            } while (beamX >= 0 && beamX < MAZE_COLS && beamY >= 0 && beamY < MAZE_ROWS 
                    && maze[beamY][beamX] !== 20
                    && maze[beamY][beamX] !== 21
                    && maze[beamY][beamX] !== 22
                    && maze[beamY][beamX] !== 23);

            return false;
        }
    
        function isImageLoaded(image) {
            return image.complete && image.naturalHeight !== 0;
        }
    
        function drawDynamicLayer() {
            dynamicCtx.clearRect(0, 0, dynamicCanvas.width, dynamicCanvas.height);   
            dynamicCtx.drawImage(characterImage, character.x * TILE_SIZE, character.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            dynamicElements.forEach(element => element.draw());
        }
    
        function updateTurn() {
            dynamicElements.forEach(element => element.update());
        }
    
        function moveCharacter(dx, dy, newImage) {
        const newX = character.x + dx;
        const newY = character.y + dy;
        if (newX >= 0 && newX < MAZE_COLS && newY >= 0 && newY < MAZE_ROWS && 
            maze[newY][newX] !== 20 && 
            maze[newY][newX] !== 21 && 
            maze[newY][newX] !== 22 && 
            maze[newY][newX] !== 23 && 
            !isTurret(newX, newY)) {
            character.x = newX;
            character.y = newY;
            characterImage = newImage;
            updateTurn();
            drawDynamicLayer();
            if (maze[newY][newX] === 9) {
                showWinModal();
            } else if (checkCollisions(newX, newY)) {
                setTimeout(() => {
                    alert("You lose");
                    restartGame();
                }, 50);
            }
        }
    }
    
        function isTurret(x, y) {
            return dynamicElements.some(element => element.type === 'turret' && element.x === x && element.y === y);
        }
    
        function checkCollisions(x, y) {
            return dynamicElements.some(element => element.checkCollision && element.checkCollision(x, y));
        }
    
        function restartGame() {
            character = undefined;
            characterImage = image.character.down;
            dynamicElements = [];
            dynamicCtx.clearRect(0, 0, dynamicCanvas.width, dynamicCanvas.height);
            initDynElementsPosition();
            drawDynamicLayer();
        }
  
        document.addEventListener('keydown', (event) => {
            const moves = {
                'ArrowUp': [0, -1, image.character.up],
                'ArrowDown': [0, 1, image.character.down],
                'ArrowLeft': [-1, 0, image.character.left],
                'ArrowRight': [1, 0, image.character.right]
            };
            if (moves[event.key]) {
                moveCharacter(...moves[event.key]);
            }
        });
    
        function showWinModal() {
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('winModal').style.display = 'block';
        }
    
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('winModal').style.display = 'none';
            restartGame()
        });
    
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function handleOrientation() {
            if (isMobile()) {
                // The CSS will handle the rotation for mobile devices
                document.body.style.overflow = 'hidden';
            } else {
                // For non-mobile devices, reset any applied styles
                document.body.style.transform = '';
                document.body.style.transformOrigin = '';
                document.body.style.width = '';
                document.body.style.height = '';
                document.body.style.position = '';
                document.body.style.overflow = '';
            }
        }

        // Check orientation on page load and resize
        window.addEventListener('load', handleOrientation);
        window.addEventListener('resize', handleOrientation);

        // Prevent default touch behavior to avoid zooming
        document.addEventListener('touchmove', function(event) {
            if (event.scale !== 1) {
                event.preventDefault();
            }
        }, { passive: false });

        // Initialize the game
        init();
    </script>
</body>
</html>